from json import loads

import requests

from common import get_env_variable_required


class SeniorXFrontendHelper(object):
    def __init__(self):
        self.base_url = (
            "https://platform.senior.com.br/t/senior.com.br/bridge/1.0/rest/platform/"
        )
        self.session = requests.session()
        self.session.headers = {"Content-Type": "application/json"}
        self._login()

    def _login(self):
        response = self._post(
            "authentication/actions/loginWithKey",
            {
                "accessKey": get_env_variable_required("SCI_SENIORX_ACCESS_KEY"),
                "secret": get_env_variable_required("SCI_SENIORX_SECRET"),
                "tenantName": "senior",
            },
        )
        response = response.json()["jsonToken"]
        token = loads(response)["access_token"]
        self.session.headers.update({"Authorization": f"Bearer {token}"})

    def get_current_deployed_version(self, identifier):
        response = self._post(
            "frontend_updater/queries/getFrontend", {"identifiers": [identifier]}
        )
        if len(response.json()["frontends"]) > 0:
            return response.json()["frontends"][0]["currentVersion"]
        return None

    def _post(self, url: str, data: dict):
        return self.session.post(
            f"{self.base_url}{url}",
            json=data,
            timeout=30.0,
        )
