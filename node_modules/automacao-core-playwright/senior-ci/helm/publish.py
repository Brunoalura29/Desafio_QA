import sys

sys.path.append("./senior-ci")

from common import exec_command, exit_message, get_env_variable_required
from common.extensions import Extensions
from helm import add_nexus_repo, get_version

add_nexus_repo()

chart_name = get_env_variable_required("SCI_CHART_NAME")

nexus_username = get_env_variable_required("NEXUS_USERNAME")
nexus_password = get_env_variable_required("NEXUS_PASSWORD")

chart_path = f"./charts/{chart_name}"

version = get_version(chart_path)

if not version:
    exit_message(f"Não foi possível encontrar a versão do chart {chart_name}")

exec_command(
    f"helm nexus-push nexus-senior login -u {nexus_username} -p {nexus_password}",
    print_command=False,
)

extensions = Extensions()

extensions.before_packaging()

exec_command(f"helm package ./charts/{chart_name} --version {version}")
exec_command(
    f"helm nexus-push nexus-senior {chart_name}-{version}.tgz -u {nexus_username} -p ''"
)

extensions.after_packaging()
