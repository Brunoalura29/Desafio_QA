from pathlib import Path
from uuid import uuid4

from common import get_env_variable_required, is_semver
from src.interface.angular_project import AngularProjectInterface


class AngularLib(AngularProjectInterface):
    def __init__(self):
        super().__init__()

        self.package_json = Path("lib/package.json")

    def package(self):
        npm_token = get_env_variable_required("NPM_TOKEN")
        source_folder_npm = get_env_variable_required("SOURCE_FOLDER_NPM")

        if self.sci_deploy_cdn:
            self._deploy_to_cdn()

        npmrc_path = Path(".npmrc")
        npmrc_path.write_text(
            f"//registry.npmjs.org/:_authToken={npm_token}\n", encoding="utf-8"
        )

        self._execute_npm_command("config set registry https://registry.npmjs.org/")

        tag_npm = ""

        if not is_semver(self.version):
            package_name = self._get_package_json_attribute("name")

            latest_npm_version = self._execute_npm_command(
                f"npm view {package_name} version"
            )

            tag_npm = f"--tag {self.version}"
            self.version = f"{latest_npm_version}-{str(uuid4())}"

        self._execute_npm_command(f"--no-git-tag-version version {self.version}")

        self._execute_npm_command(
            f"publish {source_folder_npm} --access public {tag_npm}"
        )
