import fnmatch
import os
import shutil

from colorama import Fore

from common import is_path_exist, print_message
from src.interface.project import ProjectInterface


class DotnetProjectInterface(ProjectInterface):
    def __init__(self) -> None:
        super().__init__()
        if not is_path_exist("packages.lock.json"):
            self._find_and_copy_first_packages_lock_json()

    @staticmethod
    def _find_and_copy_first_packages_lock_json():
        for root, _, files in os.walk("."):
            for filename in fnmatch.filter(files, "packages.lock.json"):
                file_path = os.path.join(root, filename)
                shutil.copy(file_path, ".")
                print_message(f"{file_path} copiado para o diretório raiz do projeto")
                return

        print_message(
            "Não foi possível encontrar nenhum arquivo package.lock.json. "
            "Por favor, configure seu projeto para gera-los e faça o commit do mesmo\n"
            "Documentação para habilitar a geração do arquivo: "
            "https://learn.microsoft.com/en-us/nuget/consume-packages/package-references-in-project-files#enabling-the-lock-file",
            fore_color=Fore.YELLOW,
        )

    def _sources_to_be_scanned(self):
        return [self.ci_project_dir]
